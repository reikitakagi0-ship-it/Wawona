# EGL Research: Zink + Vulkan + Wayland on macOS

## Overview

This document tracks research and implementation of EGL support for macOS using Zink (OpenGL ES → Vulkan translation) on top of KosmicKrisp (Vulkan 1.3 driver for macOS).

## Problem Statement

On macOS, we need EGL to work with Wayland clients (like `weston-simple-egl`). However:
- macOS deprecated OpenGL/ES since Mojave
- We're using Zink (OpenGL ES → Vulkan) on top of KosmicKrisp (Vulkan driver)
- MoltenVK (the Vulkan implementation on macOS) doesn't support `VK_KHR_wayland_surface`
- We need to access Mesa's WSI (Window System Integration) Wayland functions

## Architecture

### Linux (Normal Flow)
1. Application creates Vulkan instance with `VK_KHR_wayland_surface` extension
2. Mesa's WSI layer provides `vkCreateWaylandSurfaceKHR` function
3. Function is accessible via `vkGetInstanceProcAddr` or Mesa's dispatch table
4. Zink uses these functions to create Wayland surfaces

### macOS (Our Challenge)
1. MoltenVK creates the Vulkan instance (not Mesa)
2. MoltenVK doesn't support `VK_KHR_wayland_surface` extension
3. We can't enable the extension during instance creation (MoltenVK rejects it)
4. We need to access Mesa's WSI functions directly, bypassing MoltenVK

## Solution: Mesa WSI Entrypoint Table

### Key Discovery

Mesa exports a global symbol `wsi_instance_entrypoints` which is a `const struct vk_instance_entrypoint_table` containing function pointers to all WSI functions, including:
- `CreateWaylandSurfaceKHR`
- `GetPhysicalDeviceWaylandPresentationSupportKHR`

This table is populated at compile time and contains direct function pointers to Mesa's WSI implementations.

### Implementation Approach

Instead of trying to access Mesa's instance dispatch table (which requires a Mesa instance), we can access the WSI entrypoint table directly:

```c
#include "vulkan/wsi/wsi_common.h"  // Exports wsi_instance_entrypoints

// Access function pointer directly
PFN_vkCreateWaylandSurfaceKHR create_func = 
    wsi_instance_entrypoints.CreateWaylandSurfaceKHR;
```

### Current Status

**Fixed**: Assertion failure when trying to access Mesa instance structure
- Problem: `VK_FROM_HANDLE` expects a Mesa instance, but MoltenVK creates the instance
- Solution: Access `wsi_instance_entrypoints` directly instead of trying to access instance dispatch table

**In Progress**: Function pointer access
- Updated `zink_instance.py` to access `wsi_instance_entrypoints.CreateWaylandSurfaceKHR` directly
- Need to verify function pointer is non-NULL and works correctly

**Pending**: Function call compatibility
- `wsi_CreateWaylandSurfaceKHR` uses `VK_FROM_HANDLE` internally, which expects a Mesa instance
- May need to create a wrapper or modify WSI function to handle MoltenVK instances

## Files Modified

### `/Users/alex/Wawona/kosmickrisp/src/gallium/drivers/zink/zink_instance.py`
- Added include for `vulkan/wsi/wsi_common.h`
- Modified `zink_verify_instance_extensions` to access `wsi_instance_entrypoints` directly
- Removed attempt to access Mesa instance dispatch table (which caused assertion failure)

## Research Notes

### Mesa WSI Entrypoint Table Structure

The entrypoint table is generated by `vk_entrypoints_gen.py` and contains:
- Function pointers for all WSI entrypoints
- Weak symbols that resolve to NULL if not implemented
- Platform-specific guards (`VK_USE_PLATFORM_WAYLAND_KHR`)

### How It Works on Linux

1. Mesa creates the Vulkan instance
2. WSI entrypoints are registered in the instance dispatch table
3. `vkGetInstanceProcAddr` queries the dispatch table
4. Functions are accessible through normal Vulkan API

### How We're Making It Work on macOS

1. MoltenVK creates the Vulkan instance
2. We bypass `vkGetInstanceProcAddr` (which queries MoltenVK)
3. We access `wsi_instance_entrypoints` directly (Mesa's global table)
4. We use the function pointers directly

## Next Steps

1. ✅ Fix assertion failure (access entrypoint table directly)
2. ⏳ Verify function pointers are non-NULL
3. ⏳ Test `wsi_CreateWaylandSurfaceKHR` with MoltenVK instance
4. ⏳ Handle potential `VK_FROM_HANDLE` issues in WSI functions
5. ⏳ Test `weston-simple-egl` end-to-end

## References

- Mesa WSI code: `kosmickrisp/src/vulkan/wsi/`
- Entrypoint generation: `kosmickrisp/src/vulkan/util/vk_entrypoints_gen.py`
- Zink instance code: `kosmickrisp/src/gallium/drivers/zink/zink_instance.py`
- WSI Wayland implementation: `kosmickrisp/src/vulkan/wsi/wsi_common_wayland.c`

## Debugging

### Logs to Check
- `[ZINK]` prefixed logs in `zink_verify_instance_extensions`
- Function pointer values (should be non-NULL)
- Error messages from `wsi_CreateWaylandSurfaceKHR` if called

### Environment Variables
- `EGL_PLATFORM=wayland` - Forces Wayland platform
- `WAYLAND_DEBUG=1` - Enables Wayland protocol logging
- `MESA_LOADER_DRIVER_OVERRIDE=zink` - Forces Zink driver

