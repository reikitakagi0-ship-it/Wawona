name: KosmicKrisp Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'Makefile'
      - '.github/workflows/kosmickrisp-tests.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'Makefile'
      - '.github/workflows/kosmickrisp-tests.yml'
  workflow_dispatch:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'

env:
  MACOS_VERSION: '14'

jobs:
  kosmickrisp-build:
    name: Build KosmicKrisp
    runs-on: macos-${{ env.MACOS_VERSION }}
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config meson ninja python3 bison llvm || true
          
      - name: Install MoltenVK
        run: |
          brew install molten-vk || true
          
      - name: Build KosmicKrisp
        env:
          PATH: /opt/homebrew/opt/bison/bin:$PATH
          LLVM_CONFIG: /opt/homebrew/opt/llvm/bin/llvm-config
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH
        run: |
          make kosmickrisp 2>&1 | tee /tmp/kosmickrisp-build.log || exit 1
          
      - name: Verify installation
        run: |
          echo "Verifying KosmicKrisp installation..."
          
          # Check Vulkan driver
          if [ -f "/opt/homebrew/lib/libvulkan_kosmickrisp.dylib" ]; then
            echo "✅ Vulkan driver library found"
          else
            echo "❌ Vulkan driver library NOT found"
            exit 1
          fi
          
          if [ -f "/opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json" ] || \
             [ -f "/opt/homebrew/share/vulkan/icd.d/kosmickrisp_icd.json" ]; then
            echo "✅ Vulkan ICD file found"
          else
            echo "❌ Vulkan ICD file NOT found"
            exit 1
          fi
          
          # Check EGL library
          if [ -f "/opt/homebrew/lib/libEGL.dylib" ]; then
            echo "✅ EGL library found"
          else
            echo "❌ EGL library NOT found"
            exit 1
          fi
          
          # Check OpenGL ES libraries
          if [ -f "/opt/homebrew/lib/libGLESv2.dylib" ]; then
            echo "✅ OpenGL ES 2.0 library found"
          else
            echo "❌ OpenGL ES 2.0 library NOT found"
            exit 1
          fi
          
          if [ -f "/opt/homebrew/lib/libGLESv1_CM.dylib" ]; then
            echo "✅ OpenGL ES 1.0 library found"
          else
            echo "⚠️ OpenGL ES 1.0 library NOT found (optional)"
          fi
          
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kosmickrisp-build-logs
          path: /tmp/kosmickrisp-build.log
          retention-days: 7

  kosmickrisp-vulkan-test:
    name: KosmicKrisp Vulkan Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    needs: kosmickrisp-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install Vulkan tools
        run: |
          brew install vulkan-tools || true
          
      - name: Test Vulkan driver
        env:
          VK_ICD_FILENAMES: /opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
        run: |
          echo "Testing Vulkan driver..."
          
          # Test vulkaninfo
          if command -v vulkaninfo >/dev/null 2>&1; then
            vulkaninfo --summary > /tmp/vulkaninfo.log 2>&1 || true
            if grep -q "KosmicKrisp\|kosmickrisp" /tmp/vulkaninfo.log; then
              echo "✅ KosmicKrisp driver detected by vulkaninfo"
              cat /tmp/vulkaninfo.log | head -50
            else
              echo "⚠️ KosmicKrisp driver not detected by vulkaninfo"
              cat /tmp/vulkaninfo.log
            fi
          else
            echo "⚠️ vulkaninfo not available, skipping"
          fi
          
          # Test vkcube if available
          if command -v vkcube >/dev/null 2>&1; then
            timeout 5s vkcube --c 10 > /tmp/vkcube.log 2>&1 || true
            if [ $? -eq 0 ] || grep -q "KosmicKrisp\|kosmickrisp" /tmp/vkcube.log; then
              echo "✅ vkcube test passed"
            else
              echo "⚠️ vkcube test had issues (may be expected in headless CI)"
              cat /tmp/vkcube.log | tail -20
            fi
          else
            echo "⚠️ vkcube not available, skipping"
          fi

  kosmickrisp-egl-test:
    name: KosmicKrisp EGL Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    needs: kosmickrisp-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Build EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH
        run: |
          if [ -f "test-egl-comprehensive.c" ]; then
            clang -o test-egl-comprehensive test-egl-comprehensive.c \
              -I/opt/homebrew/include \
              -L/opt/homebrew/lib \
              -lEGL -lGLESv2 \
              -framework Foundation -framework Metal -framework MetalKit \
              -std=c11 -Wall -Wextra || exit 1
          else
            echo "⚠️ test-egl-comprehensive.c not found"
            exit 0
          fi
          
      - name: Run EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          LIBGL_DRIVERS_PATH: /opt/homebrew/lib/dri
          MESA_LOADER_DRIVER_OVERRIDE: zink
          VK_ICD_FILENAMES: /opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json
        run: |
          if [ -f "./test-egl-comprehensive" ]; then
            ./test-egl-comprehensive > /tmp/kosmickrisp-egl-test.log 2>&1
            TEST_EXIT=$?
            cat /tmp/kosmickrisp-egl-test.log
            if [ $TEST_EXIT -ne 0 ]; then
              echo "❌ EGL test failed"
              exit 1
            fi
            echo "✅ EGL test passed"
          fi
          
      - name: Upload EGL test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kosmickrisp-egl-test-results
          path: /tmp/kosmickrisp-egl-test.log
          retention-days: 7

