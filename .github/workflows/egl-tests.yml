name: EGL Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'test-egl*.c'
      - 'Makefile'
      - '.github/workflows/egl-tests.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'test-egl*.c'
      - 'Makefile'
      - '.github/workflows/egl-tests.yml'
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  MACOS_VERSION: '14'

jobs:
  egl-comprehensive-test:
    name: EGL Comprehensive Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config meson ninja python3 bison llvm || true
          
      - name: Install MoltenVK
        run: |
          brew install molten-vk || true
          
      - name: Build KosmicKrisp (if needed)
        run: |
          if [ ! -f "/opt/homebrew/lib/libEGL.dylib" ] || [ ! -f "/opt/homebrew/lib/libvulkan_kosmickrisp.dylib" ]; then
            echo "Building KosmicKrisp..."
            make kosmickrisp || echo "KosmicKrisp build failed, will test with existing installation"
          else
            echo "KosmicKrisp already installed"
          fi
          
      - name: Build comprehensive EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH
        run: |
          clang -o test-egl-comprehensive test-egl-comprehensive.c \
            -I/opt/homebrew/include \
            -L/opt/homebrew/lib \
            -lEGL -lGLESv2 \
            -framework Foundation -framework Metal -framework MetalKit \
            -std=c11 -Wall -Wextra -Werror || exit 1
          
      - name: Run comprehensive EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          LIBGL_DRIVERS_PATH: /opt/homebrew/lib/dri
          MESA_LOADER_DRIVER_OVERRIDE: zink
          VK_ICD_FILENAMES: /opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json
        run: |
          ./test-egl-comprehensive > /tmp/egl-test.log 2>&1
          TEST_EXIT=$?
          cat /tmp/egl-test.log
          if [ $TEST_EXIT -ne 0 ]; then
            echo "❌ EGL comprehensive test failed"
            exit 1
          fi
          echo "✅ EGL comprehensive test passed"
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: egl-test-results
          path: /tmp/egl-test.log
          retention-days: 7

  egl-simple-test:
    name: EGL Simple Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config || true
          
      - name: Build simple EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH
        run: |
          if [ -f "test-egl-simple.c" ]; then
            clang -o test-egl-simple test-egl-simple.c \
              -I/opt/homebrew/include \
              -L/opt/homebrew/lib \
              -lEGL -lGLESv2 \
              -framework Foundation -framework Metal \
              -std=c11 -Wall -Wextra || exit 1
          else
            echo "⚠️ test-egl-simple.c not found, skipping"
            exit 0
          fi
          
      - name: Run simple EGL test
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          LIBGL_DRIVERS_PATH: /opt/homebrew/lib/dri
          MESA_LOADER_DRIVER_OVERRIDE: zink
        run: |
          if [ -f "./test-egl-simple" ]; then
            ./test-egl-simple > /tmp/egl-simple-test.log 2>&1
            TEST_EXIT=$?
            cat /tmp/egl-simple-test.log
            if [ $TEST_EXIT -ne 0 ]; then
              echo "❌ EGL simple test failed"
              exit 1
            fi
            echo "✅ EGL simple test passed"
          fi

