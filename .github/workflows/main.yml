name: Build iOS xcarchive (Nix, refresh mesa)

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26
    env:
      XCODE_APP: /Applications/Xcode.app  # Xcode を選択する場合

    steps:
      # 1. リポジトリのチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Xcode をセットアップ
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Select Xcode
        run: |
          sudo xcode-select -s "$XCODE_APP"
          xcodebuild -version

      # 3. Nix をインストール
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Enable Nix flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v6
        with:
          flakehub: false

      # 4. Mesa fixed-output hash mismatch 回避
      - name: Refresh mesa fixed-output hash
        run: |
          nix build .#mesa --refresh -L || true

      # 5. iOS ビルド本体（Waypipe）
      - name: Build waypipe-ios
        run: |
          nix build .#waypipe-ios -L

      # 6. Xcode プロジェクト自動検出
      - name: Detect Xcode project
        id: detect_proj
        run: |
          PROJ=$(find . -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJ" ]; then
            echo "No .xcodeproj found!"
            exit 1
          fi
          echo "Found Xcode project: $PROJ"
          echo "project_path=$PROJ" >> $GITHUB_OUTPUT

      # 7. xcarchive のビルド
      - name: Build xcarchive
        run: |
          mkdir -p artifacts
          xcodebuild -project "${{ steps.detect_proj.outputs.project_path }}" \
                     -scheme Waypipe \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath $PWD/artifacts/Waypipe.xcarchive \
                     clean archive

      # 8. xcarchive をアップロード
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: waypipe-ios-xcarchive
          path: artifacts/*.xcarchive