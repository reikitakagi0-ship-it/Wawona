name: Build iOS (Waypipe / Nix)

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26

    env:
      XCODE_APP: /Applications/Xcode.app  # Xcode のパスを指定

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup Xcode
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Verify Xcode
        run: |
          sudo xcode-select -s "$XCODE_APP"
          xcodebuild -version

      # 3. Install Nix
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      # 4. Enable Nix flakes & nix-command
      - name: Enable Nix flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      # 5. Configure Nix cache (optional)
      - name: Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v6
        with:
          flakehub: false

      # 6. Refresh mesa hash to avoid fixed-output mismatch
      - name: Refresh mesa fixed-output hash
        run: |
          nix build .#mesa --refresh -L || true

      # 7. Build Waypipe iOS
      - name: Build Waypipe iOS
        run: |
          nix build .#waypipe-ios -L

      # 8. Collect build artifacts
      - name: Collect build artifacts
        run: |
          mkdir -p artifacts
          cp -R result/* artifacts/

      # 9. Upload artifacts to GitHub
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: waypipe-ios
          path: artifacts/