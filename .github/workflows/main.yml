name: Build iOS xcarchive (Nix + Xcode)

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26  # Apple Silicon macOS

    env:
      XCODE_APP: /Applications/Xcode.app  # Xcode のパス

    steps:
      # 1. Xcode セットアップ
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      # 2. リポジトリのチェックアウト
      - name: Checkout
        uses: actions/checkout@v4

      # 3. Xcode 選択（wrapper 対策）
      - name: Select Xcode
        run: |
          sudo xcode-select -s "$XCODE_APP"
          xcodebuild -version

      # 4. Nix インストール
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      # 5. Nix flakes 有効化
      - name: Enable Nix flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      # 6. FlakeHub は無効（ノイズ防止）
      - name: Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v6
        with:
          flakehub: false

      # 7. mesa fixed-output hash を更新（hash mismatch 回避）
      - name: Refresh mesa fixed-output hash
        run: |
          nix build .#mesa --refresh -L || true

      # 8. Nix で waypipe-ios をビルド
      - name: Build waypipe-ios via Nix
        run: |
          nix build .#waypipe-ios -L

      # 9. Xcode で実機向けアーカイブを作成
      - name: Archive iOS app
        run: |
          mkdir -p artifacts
          xcodebuild -project Path/To/Waypipe.xcodeproj \
                     -scheme Waypipe \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath $PWD/artifacts/Waypipe.xcarchive \
                     clean archive

      # 10. xcarchive をアップロード
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: waypipe-ios-xcarchive
          path: artifacts/*.xcarchive