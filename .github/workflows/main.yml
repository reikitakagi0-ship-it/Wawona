name: make Build All iOS xcarchive (Waypipe, Dependencies, Nix)

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26  # Apple Silicon または macOS での実行

    env:
      XCODE_APP: /Applications/Xcode.app  # Xcode のパス

    steps:
      # 1. リポジトリをクローン
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Xcode を選択（バージョン指定）
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Select Xcode
        run: |
          sudo xcode-select -s "$XCODE_APP"
          xcodebuild -version

      # 3. Nix のインストール
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      # 4. Nix Flakes を有効化
      - name: Enable Nix flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      # 5. mesa の fixed-output hash mismatch 回避
      - name: Refresh mesa fixed-output hash
        run: |
          nix build .#mesa --refresh -L || true

      # 6. すべての依存関係をビルドする
      - name: Build all dependencies for iOS
        run: |
          # 依存関係をすべてビルドする（順番にビルド）
          nix build .#ffmpeg-ios -L
          nix build .#libwayland-ios -L
          nix build .#lz4-ios -L
          nix build .#zstd-ios -L
          nix build .#libffi-ios -L
          nix build .#libxml2-ios -L
          nix build .#epoll-shim-ios -L
          nix build .#kosmickrisp-ios -L  # Vulkan ベースの Wayland compositor

      # 7. Xcode プロジェクトの自動検出
      - name: Find Xcode project
        run: |
          PROJ=$(find . -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJ" ]; then
            echo "No .xcodeproj found!"
            exit 1
          fi
          echo "Found Xcode project: $PROJ"
          echo "project_path=$PROJ" >> $GITHUB_OUTPUT

      # 8. xcarchive を生成
      - name: Build iOS xcarchive
        run: |
          # .xcodeproj が見つかった場合、そのプロジェクトを使って xcarchive をビルド
          xcodebuild -project "$PROJECT_PATH" \
                     -scheme Waypipe \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath $PWD/artifacts/Waypipe.xcarchive \
                     clean archive

      # 9. xcarchive を収集
      - name: Collect xcarchive
        run: |
          mkdir -p artifacts
          find $PWD/artifacts -name "*.xcarchive" -exec cp -R {} artifacts/

      # 10. xcarchive をアップロード
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: waypipe-ios-xcarchive
          path: artifacts/*.xcarchive