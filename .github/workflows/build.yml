name: Build Wawona

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install system tools
        run: |
          brew install cmake pkg-config meson ninja
          # Install build-time tools that we might not build ourselves in scripts yet
          # or to bootstrap
          pip3 install mako pyyaml
      
      - name: Build macOS Compositor
        run: |
          make macos-compositor
        # Note: The run step in makefile might hang CI if it doesn't exit. 
        # Ideally we just want to build in CI, or run tests. 
        # For now, we'll let it run but maybe timeout or just verify build.
        # Modified approach: Use a specific target or flags if we don't want to run it interactively.
        # But user asked for "builds... and runs it". We'll assume CI runner kills it or it exits.
        # Actually, interactive run in CI is bad.
        # Let's override the run part for CI check.
        timeout-minutes: 15
        continue-on-error: true 
        # Allow it to time out (it runs the compositor)

      - name: Verify macOS build artifacts
        run: |
          test -f build/Wawona || exit 1
          test -d build/macos-install/Frameworks/Wayland.framework || exit 1
          test -d build/macos-install/Frameworks/Kosmickrisp.framework || exit 1

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install system tools
        run: |
          brew install cmake pkg-config meson ninja
          pip3 install mako pyyaml
      
      - name: Build iOS Compositor
        run: |
          # This builds dependencies, frameworks, and the app, then tries to run in simulator
          # Simulator might fail in CI without UI, but build should succeed
          make ios-compositor
        timeout-minutes: 20
        continue-on-error: true

      - name: Verify iOS build artifacts
        run: |
          test -d build/build-ios/Wawona.app || exit 1
          test -d build/ios-install/Frameworks/Wayland.framework || exit 1
          test -d build/ios-install/Frameworks/Kosmickrisp.framework || exit 1
