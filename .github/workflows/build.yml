name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  MACOS_VERSION: '14'

jobs:
  build:
    name: Build Wawona
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config pixman wayland || true
          
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Run tests
        run: |
          cd build
          if [ -f tests/test_wayland_client ]; then
            ./tests/test_wayland_client || true
          fi
          
      - name: Check binary exists
        run: |
          if [ ! -f build/Wawona ]; then
            echo "❌ Binary not found!"
            exit 1
          fi
          echo "✅ Build successful!"
          ls -lh build/Wawona

  lint:
    name: Lint Code
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install clang-format and clang-tidy
        run: |
          brew install clang-format llvm || true
          
      - name: Check formatting
        run: |
          find src -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror || exit 1
          find src -name "*.m" -o -name "*.h" | xargs clang-format --dry-run --Werror || exit 1
          
      - name: Run clang-tidy
        run: |
          if command -v clang-tidy >/dev/null 2>&1; then
            find src -name "*.c" -o -name "*.h" | head -5 | xargs clang-tidy -p build/ || true
          else
            echo "⚠️ clang-tidy not available, skipping"
          fi

  protocol-check:
    name: Verify Protocols
    runs-on: macos-${{ env.MACOS_VERSION }}
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config pixman wayland || true
          
      - name: Build test client
        run: |
          make -f Makefile.test_client macos_wlclient_color_test || true
          
      - name: Check protocol implementations
        run: |
          echo "Checking for protocol implementations..."
          PROTOCOLS=(
            "wl_compositor"
            "wl_output"
            "wl_seat"
            "wl_shm"
            "wl_subcompositor"
            "wl_data_device_manager"
            "xdg_wm_base"
            "zwp_linux_dmabuf_v1"
            "zwp_screencopy_manager_v1"
            "wp_color_manager_v1"
          )
          for proto in "${PROTOCOLS[@]}"; do
            if grep -r "wl_global_create.*$proto" src/ >/dev/null 2>&1; then
              echo "✅ $proto found"
            else
              echo "❌ $proto NOT FOUND"
              exit 1
            fi
          done
          
      - name: Test Color Operations Protocol Compliance
        run: |
          echo "Testing Color Operations Protocol Compliance..."
          mkdir -p /tmp/wayland-runtime
          chmod 0700 /tmp/wayland-runtime
          export XDG_RUNTIME_DIR=/tmp/wayland-runtime
          export WAYLAND_DISPLAY=wayland-0
          
          # Build test client if not already built
          if [ ! -f macos_wlclient_color_test ]; then
            make -f Makefile.test_client macos_wlclient_color_test || exit 1
          fi
          
          # Start compositor in background
          timeout 15s build/Wawona > /tmp/compositor.log 2>&1 &
          COMPOSITOR_PID=$!
          sleep 3
          
          # Check if compositor is running
          if ! kill -0 $COMPOSITOR_PID 2>/dev/null; then
            echo "❌ Compositor failed to start"
            cat /tmp/compositor.log
            exit 1
          fi
          
          # Run test client and capture output
          timeout 8s ./macos_wlclient_color_test > /tmp/client.log 2>&1 || true
          
          # Check if color operations protocol is advertised
          if grep -q "Color Operations Support: yes" /tmp/client.log; then
            echo "✅ Color Operations Protocol: Supported"
          else
            echo "❌ Color Operations Protocol: NOT SUPPORTED"
            echo "Client output:"
            cat /tmp/client.log | head -50
            echo ""
            echo "Compositor output:"
            cat /tmp/compositor.log | tail -20
            exit 1
          fi
          
          # Check for required features
          if grep -q "ICC Profile Support: yes" /tmp/client.log; then
            echo "✅ ICC Profile Support: Present"
          else
            echo "⚠️ ICC Profile Support: Not advertised"
          fi
          
          # Check for HDR support (may not be available on CI)
          if grep -q "HDR Support: yes" /tmp/client.log; then
            echo "✅ HDR Support: Present"
          else
            echo "⚠️ HDR Support: Not advertised (may be expected on non-HDR displays)"
          fi
          
          # Verify protocol summary was printed
          if grep -q "Supported Features:" /tmp/client.log && grep -q "Supported Transfer Functions:" /tmp/client.log; then
            echo "✅ Protocol summary printed correctly"
          else
            echo "⚠️ Protocol summary may be incomplete"
          fi
          
          # Cleanup
          kill $COMPOSITOR_PID 2>/dev/null || true
          wait $COMPOSITOR_PID 2>/dev/null || true

