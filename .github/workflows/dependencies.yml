name: Test Dependencies

on:
  push:
    branches: [ master, main ]
    paths:
      - 'dependencies/**'
      - 'scripts/install-*.sh'
      - 'Makefile'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'dependencies/**'
      - 'scripts/install-*.sh'
      - 'Makefile'
  schedule:
    # Run weekly to test dependency updates
    - cron: '0 0 * * 0'

jobs:
  test-dependencies-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          brew install meson ninja pkg-config cmake
          brew install expat libffi libxml2
      
      - name: Test Wayland build
        run: |
          ./scripts/install-wayland-ios.sh || true
          # Verify build succeeded
          test -d ios-install/lib || exit 1
      
      - name: Test Pixman build
        run: |
          ./scripts/install-pixman-ios.sh || true
          test -f ios-install/lib/libpixman-1.a || exit 1
      
      - name: Test libffi build
        run: |
          ./scripts/install-libffi-ios.sh || true
          test -f ios-install/lib/libffi.a || exit 1
      
      - name: Test epoll-shim build
        run: |
          ./scripts/install-epoll-shim-ios.sh || true
          test -f ios-install/lib/libepoll-shim.a || exit 1
      
      - name: Test zstd build
        run: |
          ./scripts/install-zstd-ios.sh || true
          test -f ios-install/lib/libzstd.a || exit 1
      
      - name: Test lz4 build
        run: |
          ./scripts/install-lz4-ios.sh || true
          test -f ios-install/lib/liblz4.a || exit 1

  test-kosmickrisp-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          brew install meson ninja pkg-config cmake
          brew install llvm libclc
          pip3 install mako pyyaml
      
      - name: Build KosmicKrisp for macOS
        run: |
          make kosmickrisp-macos || true
          # Verify build
          test -f /opt/homebrew/lib/libvulkan_kosmickrisp.dylib || \
          test -d dependencies/kosmickrisp/build || exit 1
      
      - name: Build KosmicKrisp for iOS
        run: |
          make ios-kosmickrisp || true
          test -f ios-install/lib/libvulkan_kosmickrisp.dylib || \
          test -d dependencies/kosmickrisp/build-ios || exit 1

  test-waypipe:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Install dependencies
        run: |
          brew install pkg-config
      
      - name: Build Waypipe
        run: |
          make build-waypipe || true
          test -f dependencies/waypipe/target/release/waypipe || exit 1

  verify-strict-compilation:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Check compilation flags
        run: |
          # Verify -Werror is used
          grep -r "Werror" scripts/ Makefile CMakeLists.txt || exit 1
          # Verify strict flags
          grep -r "Wall.*Wextra.*Wpedantic" scripts/ Makefile CMakeLists.txt || exit 1
