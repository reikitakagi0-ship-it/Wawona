name: Zink + MoltenVK Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'test-egl*.c'
      - 'Makefile'
      - '.github/workflows/zink-moltenvk-tests.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'kosmickrisp/**'
      - 'test-egl*.c'
      - 'Makefile'
      - '.github/workflows/zink-moltenvk-tests.yml'
  workflow_dispatch:
  schedule:
    # Run daily at 4 AM UTC
    - cron: '0 4 * * *'

env:
  MACOS_VERSION: '14'

jobs:
  zink-driver-test:
    name: Zink Driver Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config meson ninja python3 bison llvm molten-vk || true
          
      - name: Verify MoltenVK installation
        run: |
          echo "Checking MoltenVK installation..."
          if [ -d "$(brew --prefix molten-vk)" ]; then
            echo "✅ MoltenVK found at $(brew --prefix molten-vk)"
          else
            echo "❌ MoltenVK not found"
            exit 1
          fi
          
      - name: Build KosmicKrisp with Zink
        env:
          PATH: /opt/homebrew/opt/bison/bin:$PATH
          LLVM_CONFIG: /opt/homebrew/opt/llvm/bin/llvm-config
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH
        run: |
          make kosmickrisp 2>&1 | tee /tmp/zink-build.log || exit 1
          
      - name: Verify Zink driver
        run: |
          echo "Verifying Zink driver..."
          
          # Check if Zink is available
          if [ -f "/opt/homebrew/lib/dri/zink_dri.so" ] || \
             [ -f "/opt/homebrew/lib/dri/libgallium_dri.dylib" ]; then
            echo "✅ Zink driver found"
          else
            echo "⚠️ Zink driver not found (may be bundled in libgallium)"
          fi
          
          # Check EGL with Zink
          if [ -f "/opt/homebrew/lib/libEGL.dylib" ]; then
            echo "✅ EGL library found"
          else
            echo "❌ EGL library NOT found"
            exit 1
          fi
          
      - name: Test Zink with EGL
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          LIBGL_DRIVERS_PATH: /opt/homebrew/lib/dri
          MESA_LOADER_DRIVER_OVERRIDE: zink
          VK_ICD_FILENAMES: /opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json
        run: |
          echo "Testing Zink driver with EGL..."
          
          # Build test if needed
          if [ -f "test-egl-comprehensive.c" ] && [ ! -f "./test-egl-comprehensive" ]; then
            clang -o test-egl-comprehensive test-egl-comprehensive.c \
              -I/opt/homebrew/include \
              -L/opt/homebrew/lib \
              -lEGL -lGLESv2 \
              -framework Foundation -framework Metal -framework MetalKit \
              -std=c11 -Wall -Wextra || exit 1
          fi
          
          # Run test
          if [ -f "./test-egl-comprehensive" ]; then
            ./test-egl-comprehensive > /tmp/zink-egl-test.log 2>&1
            TEST_EXIT=$?
            
            # Check for Zink-specific output
            if grep -q "Zink\|zink" /tmp/zink-egl-test.log; then
              echo "✅ Zink driver detected in test output"
            fi
            
            # Check for nullDescriptor requirement (should be satisfied)
            if grep -q "nullDescriptor\|robustness2" /tmp/zink-egl-test.log; then
              echo "✅ Robustness2 features detected"
            fi
            
            cat /tmp/zink-egl-test.log
            
            if [ $TEST_EXIT -ne 0 ]; then
              echo "❌ Zink EGL test failed"
              exit 1
            fi
            echo "✅ Zink EGL test passed"
          fi
          
      - name: Upload Zink test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zink-test-results
          path: |
            /tmp/zink-build.log
            /tmp/zink-egl-test.log
          retention-days: 7

  moltenvk-integration-test:
    name: MoltenVK Integration Test
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install molten-vk vulkan-tools || true
          
      - name: Verify MoltenVK
        run: |
          echo "Verifying MoltenVK installation..."
          
          MOLTENVK_DIR=$(brew --prefix molten-vk)
          if [ -d "$MOLTENVK_DIR" ]; then
            echo "✅ MoltenVK found at $MOLTENVK_DIR"
            ls -la "$MOLTENVK_DIR/lib" || true
          else
            echo "❌ MoltenVK not found"
            exit 1
          fi
          
      - name: Test Vulkan with MoltenVK
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
        run: |
          echo "Testing Vulkan with MoltenVK..."
          
          # Test vulkaninfo
          if command -v vulkaninfo >/dev/null 2>&1; then
            vulkaninfo --summary > /tmp/moltenvk-info.log 2>&1 || true
            if grep -q "MoltenVK\|Metal" /tmp/moltenvk-info.log; then
              echo "✅ MoltenVK detected by vulkaninfo"
              cat /tmp/moltenvk-info.log | head -30
            else
              echo "⚠️ MoltenVK not detected by vulkaninfo"
              cat /tmp/moltenvk-info.log
            fi
          else
            echo "⚠️ vulkaninfo not available"
          fi
          
      - name: Test KosmicKrisp + MoltenVK integration
        env:
          DYLD_LIBRARY_PATH: /opt/homebrew/lib:$DYLD_LIBRARY_PATH
          VK_ICD_FILENAMES: /opt/homebrew/share/vulkan/icd.d/kosmickrisp_mesa_icd.aarch64.json
        run: |
          echo "Testing KosmicKrisp + MoltenVK integration..."
          
          # Check if KosmicKrisp is installed
          if [ -f "/opt/homebrew/lib/libvulkan_kosmickrisp.dylib" ]; then
            echo "✅ KosmicKrisp Vulkan driver found"
            
            # Test that KosmicKrisp uses MoltenVK
            if command -v vulkaninfo >/dev/null 2>&1; then
              vulkaninfo --summary 2>&1 | grep -i "kosmickrisp\|moltenvk\|metal" || true
            fi
          else
            echo "⚠️ KosmicKrisp not installed, skipping integration test"
          fi

