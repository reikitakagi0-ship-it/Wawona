# Vulkan Entrypoint Stubs for iOS Static Frameworks

## Overview

When porting KosmicKrisp from macOS (`.dylib`) to iOS (static `.framework`), you need to generate `vulkan_entrypoint_stubs.c` to provide stub implementations for all Vulkan entrypoints that are declared but not implemented. This document explains why this is necessary for static frameworks but not for dynamic libraries.

## The Problem: Static Linking vs Entrypoint Tables

### What Are Entrypoint Tables?

Vulkan drivers use **entrypoint tables** - structs that contain function pointers for all Vulkan API functions. For example:

```c
struct vk_device_entrypoint_table {
    PFN_vkGetDeviceProcAddr GetDeviceProcAddr;
    PFN_vkDestroyDevice DestroyDevice;
    PFN_vkQueueSubmit QueueSubmit;
    // ... hundreds more function pointers
};
```

KosmicKrisp declares entrypoint tables that reference **all** Vulkan functions (including optional extensions), but only implements a subset (core Vulkan 1.3 functions).

### Why This Matters for iOS Static Frameworks

**With a `.dylib` (macOS):**
- The dynamic linker resolves symbols at **runtime**
- Missing symbols can be handled gracefully
- Entrypoint tables can point to NULL or stub functions that are resolved later

**With a static `.framework` (iOS):**
- The static linker must resolve **all** symbols at **build time**
- If the entrypoint table references `kk_SomeFunction` but it isn't implemented anywhere, linking fails with "undefined symbol" errors
- Every function pointer in the entrypoint tables must point to a valid function

### Why You Need `vulkan_entrypoint_stubs.c`

The stubs provide implementations for every function declared in KosmicKrisp's entrypoint tables but not actually implemented. This allows the static linker to resolve all symbols, even if the stubs just return `VK_ERROR_EXTENSION_NOT_PRESENT`.

Without these stubs, you'd get linker errors like:
```
Undefined symbols for architecture arm64:
  "_kk_AcquireNextImageKHR", referenced from:
      _kk_device_entrypoints in libvulkan_kosmickrisp.a
```

The stubs ensure every function pointer in the entrypoint tables points to a valid function, even if it's just a stub that returns an error code.

## Why It Works as `.dylib` on macOS

### Weak Symbols vs Strong Symbols

The key difference is how entrypoints are declared:

**macOS `.dylib` build:**
- Uses `--weak` flag when generating entrypoints
- Functions are declared as `__attribute__ ((weak))`
- Weak symbols can be **undefined** - they resolve to NULL at runtime
- The dynamic linker handles this gracefully

**iOS static framework build:**
- Does **NOT** use `--weak` flag
- Functions are declared as regular (strong) symbols
- Strong symbols **must** be defined for static linking
- That's why you need the stubs

### How Weak Symbols Work in `.dylib`

From the KosmicKrisp entrypoint generation code:

```c
/* Entrypoint symbols are optional, and resolves to NULL if undefined.
 * On Unix, this semantics is achieved through weak symbols.
 */
```

With weak symbols in a `.dylib`:

1. The linker doesn't require the symbol to be defined at link time
2. If `kk_SomeFunction` isn't implemented, the weak symbol resolves to NULL
3. The entrypoint table can have NULL pointers, which is fine for dynamic linking
4. At runtime, `vkGetInstanceProcAddr` checks if the function is NULL and returns NULL accordingly

### Why Static Linking Is Different

With static linking:

1. Weak symbols still need to be resolved at link time (they just have lower priority)
2. If a symbol is referenced in the entrypoint table but never defined anywhere, the static linker fails
3. You can't have NULL function pointers in a statically linked binary - every referenced symbol must exist

So the stubs provide the missing definitions that the static linker requires, even though they just return error codes. The `.dylib` doesn't need them because weak symbols allow undefined functions to resolve to NULL at runtime.

## Build Configuration

The difference is configured in `dependencies/kosmickrisp/src/kosmickrisp/vulkan/meson.build`:

### macOS `.dylib` Build (lines 125-136):
```python
# macOS/Linux: Use weak symbols (allows loader to override)
kk_entrypoints = custom_target(
    'kk_entrypoints',
    command : [
        prog_python, '@INPUT0@', '--xml', '@INPUT1@', '--proto', '--weak',
        # ... rest of command
    ],
)
```

### iOS Static Framework Build (lines 110-123):
```python
# iOS: Generate entrypoints without --weak for static library
# Strong symbols are required for static linking
kk_entrypoints = custom_target(
    'kk_entrypoints',
    command : [
        prog_python, '@INPUT0@', '--xml', '@INPUT1@', '--proto',
        # Note: NO --weak flag
        # ... rest of command
    ],
)
```

## Stub Generation

The stubs are auto-generated by `scripts/generate-vulkan-stubs.py`, which:

1. Reads `kk_entrypoints.h` from the iOS build
2. Detects which functions are actually implemented in `libvulkan_kosmickrisp.a`
3. Generates stub implementations for all declared but unimplemented functions
4. Returns appropriate error codes (`VK_ERROR_EXTENSION_NOT_PRESENT` for most functions)

### Generated Stub Example

```c
VKAPI_ATTR VkResult VKAPI_CALL kk_AcquireNextImageKHR(
    VkDevice device, 
    VkSwapchainKHR swapchain, 
    uint64_t timeout, 
    VkSemaphore semaphore, 
    VkFence fence, 
    uint32_t* pImageIndex)
{
    // Stub implementation for kk_AcquireNextImageKHR
    // This function is declared but not implemented in KosmicKrisp
    (void)device, (void)swapchain, (void)timeout, (void)semaphore, (void)fence;
    return VK_ERROR_EXTENSION_NOT_PRESENT;
}
```

## Summary

- **macOS `.dylib`**: Uses weak symbols → undefined functions resolve to NULL at runtime → no stubs needed
- **iOS static `.framework`**: Uses strong symbols → all symbols must be defined at link time → stubs required

The stubs are a **static linking requirement**, not a runtime requirement. They satisfy the linker so the static framework can be built, even though most of them just return error codes indicating the extension isn't present.

## References

- KosmicKrisp entrypoint generation: `dependencies/kosmickrisp/src/vulkan/util/vk_entrypoints_gen.py`
- Build configuration: `dependencies/kosmickrisp/src/kosmickrisp/vulkan/meson.build`
- Stub generation script: `scripts/generate-vulkan-stubs.py`
- Generated stubs: `src/vulkan_entrypoint_stubs.c`

